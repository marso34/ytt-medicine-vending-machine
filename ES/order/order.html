<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì£¼ë¬¸</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f9f9f9;
            margin: 0;
            padding: 20px;
            user-select: none; /* í…ìŠ¤íŠ¸ ì„ íƒ ë°©ì§€ */
        }
        * {
            -webkit-user-drag: none; /* Safariì—ì„œ ë“œë˜ê·¸ ë°©ì§€ */
            user-select: none; /* ëª¨ë“  í…ìŠ¤íŠ¸ ì„ íƒ ë°©ì§€ */
        }
        .container {
            max-width: 600px;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }
        h1 {
            text-align: center;
            margin-bottom: 20px;
        }
        .item-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .item-name {
            font-size: 18px;
            font-weight: bold;
        }
        .controls {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .quantity {
            width: 40px;
            text-align: center;
            font-size: 16px;
        }
        .button {
            padding: 5px 10px;
            font-size: 18px;
            font-weight: bold;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        .order-btn {
            display: block;
            margin: 20px auto 0;
            width: 100%;
            padding: 10px;
            font-size: 18px;
        }

        /* ë¬¼í’ˆ ëª©ë¡ì˜ ì„¸ë¶€ì‚¬í•­ ìŠ¤í¬ë¡¤ ì¶”ê°€ */
        #item-list {
            height: 250px; /* ìµœëŒ€ ë†’ì´ ì„¤ì • */
            overflow-y: auto;  /* ì„¸ë¶€ì‚¬í•­ì´ ë„˜ì¹˜ë©´ ì„¸ë¡œ ìŠ¤í¬ë¡¤ ì¶”ê°€ */
            cursor: pointer; /* ìŠ¤í¬ë¡¤ì„ í´ë¦­í•˜ë©´ ì»¤ì„œ ë³€ê²½ */
        }

        /* ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            width: 300px;
        }
        .modal-header {
            text-align: center;
            margin-bottom: 20px;
        }
        .modal-body {
            margin-bottom: 20px;
        }
        .modal-footer {
            display: flex;
            justify-content: space-between;
        }
        .modal button {
            width: 45%;
        }

        .home-icon {
            position: absolute;
            top: 20px;
            left: 20px;
            font-size: 24px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <a href="/home/capstone/Desktop/index.html" class="home-icon">ğŸ </a>

    <div class="container">
        <h1>ì£¼ë¬¸ ì‹œìŠ¤í…œ</h1>
        <div id="item-list">
            <!-- ë¬¼í’ˆ ë¦¬ìŠ¤íŠ¸ê°€ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤ -->
        </div>
        <button id="order-btn" class="button order-btn" disabled>ì£¼ë¬¸</button>
    </div>

    <!-- ì£¼ë¬¸ í™•ì¸ ëª¨ë‹¬ -->
    <div id="order-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>ì£¼ë¬¸ í™•ì¸</h2>
            </div>
            <div id="order-details" class="modal-body">
                <!-- ì£¼ë¬¸ ì„¸ë¶€ì‚¬í•­ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
            </div>
            <div class="modal-footer">
                <button id="confirm-order" class="button">ì£¼ë¬¸</button>
                <button id="cancel-order" class="button">ì·¨ì†Œ</button>
            </div>
        </div>
    </div>

    <script>
        // ëª¨ë“  ë“œë˜ê·¸ ë°©ì§€ ì½”ë“œ ì¶”ê°€
        document.addEventListener('mousedown', (event) => {
            event.preventDefault();
        });
        document.addEventListener('mousemove', (event) => {
            event.preventDefault();
        });
        document.addEventListener('mouseup', (event) => {
            event.preventDefault();
        });

        const itemList = document.getElementById('item-list');
        const orderButton = document.getElementById('order-btn');
        const orderModal = document.getElementById('order-modal');
        const orderDetails = document.getElementById('order-details');
        const confirmOrderButton = document.getElementById('confirm-order');
        const cancelOrderButton = document.getElementById('cancel-order');
        let orderData = {}; // ì£¼ë¬¸ ë°ì´í„° ì €ì¥ìš©

        fetch('http://127.0.0.1:8081/api/items')
            .then(response => response.json())
            .then(data => {
                console.log('ë°›ì€ ì•„ì´í…œ ë°ì´í„°:', data); // ë°›ì€ ë°ì´í„°ë¥¼ ì½˜ì†”ì— ì¶œë ¥

                // ì•„ì´í…œ ëª©ë¡ì„ ë™ì ìœ¼ë¡œ ìƒì„±
                data.forEach(item => {
                    orderData[item.name] = {
                        maxQuantity: item.maxQuantity, // ìµœëŒ€ ìˆ˜ëŸ‰ì„ ì €ì¥
                        quantity: 0 // í˜„ì¬ ìˆ˜ëŸ‰ì€ 0ìœ¼ë¡œ ì´ˆê¸°í™”
                    };
                    const row = document.createElement('div');
                    row.className = 'item-row';

                    row.innerHTML = `  
                        <span class="item-name">${item.name}</span>
                        <div class="controls">
                            <button class="button minus-btn" data-name="${item.name}">-</button>
                            <input type="text" class="quantity" id="${item.name}-quantity" value="0" readonly />
                            <button class="button plus-btn" data-name="${item.name}">+</button>
                        </div>
                    `;

                    itemList.appendChild(row);

                    // í”ŒëŸ¬ìŠ¤/ë§ˆì´ë„ˆìŠ¤ ë²„íŠ¼ í´ë¦­ ì‹œ ìˆ˜ëŸ‰ ì—…ë°ì´íŠ¸ í•¨ìˆ˜ ë°”ì¸ë”©
                    const minusBtn = row.querySelector('.minus-btn');
                    const plusBtn = row.querySelector('.plus-btn');

                    // ê° ë²„íŠ¼ì— í´ë¦­ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
                    minusBtn.addEventListener('click', () => updateQuantity(item.name, -1));
                    plusBtn.addEventListener('click', () => updateQuantity(item.name, 1));
                });

                // ì£¼ë¬¸ ë²„íŠ¼ í™œì„±í™” ì—¬ë¶€ í™•ì¸
                checkOrderButtonState();
            })
            .catch(error => console.error('ì•„ì´í…œ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error));

        // ìˆ˜ëŸ‰ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
        function updateQuantity(itemName, delta) {
            const quantityInput = document.getElementById(`${itemName}-quantity`);
            const currentQuantity = parseInt(quantityInput.value);

            // ì•„ì´í…œ ë°ì´í„°ì—ì„œ maxQuantityë¥¼ ê°€ì ¸ì˜´
            const maxQuantity = orderData[itemName].maxQuantity;

            let newQuantity = currentQuantity + delta;

            // ìˆ˜ëŸ‰ ì œí•œ: 0ë³´ë‹¤ ì‘ì€ ê°’ì€ 0ìœ¼ë¡œ, ìµœëŒ€ ìˆ˜ëŸ‰ ì´ˆê³¼ëŠ” ìµœëŒ€ ìˆ˜ëŸ‰ìœ¼ë¡œ ì„¤ì •
            if (newQuantity < 0) newQuantity = 0;
            if (newQuantity > maxQuantity) newQuantity = maxQuantity;

            quantityInput.value = newQuantity;
            orderData[itemName].quantity = newQuantity;

            checkOrderButtonState();
        }

        // ì£¼ë¬¸ ë²„íŠ¼ í™œì„±í™” ì—¬ë¶€ í™•ì¸
        function checkOrderButtonState() {
            const totalQuantity = Object.values(orderData).reduce((sum, qty) => sum + qty, 0);
            orderButton.disabled = totalQuantity === 0;
        }

        // ì£¼ë¬¸ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
        orderButton.addEventListener('click', () => {
            // ì£¼ë¬¸í•  ë°ì´í„° ìƒì„±: ìˆ˜ëŸ‰ì´ 0ë³´ë‹¤ í° í’ˆëª©ë§Œ í¬í•¨
            const orderItems = Object.keys(orderData).map(itemName => {
                const item = orderData[itemName];
                if (item.quantity > 0) {
                    return { name: itemName, quantity: item.quantity }; // ì´ë¦„ê³¼ ìˆ˜ëŸ‰ë§Œ ì „ì†¡
                }
            }).filter(item => item !== undefined); // undefined í•„í„°ë§

            if (orderItems.length > 0) {
                // ì£¼ë¬¸ í™•ì¸ íŒì—…ì— ì£¼ë¬¸ í•­ëª© í‘œì‹œ
                let orderSummary = '<ul>';
                orderItems.forEach(item => {
                    orderSummary += `<li>${item.name}: ${item.quantity}ê°œ</li>`;
                });
                orderSummary += '</ul>';
                orderDetails.innerHTML = orderSummary;

                // ëª¨ë‹¬ ì—´ê¸°
                orderModal.style.display = 'flex';
            }
        });

        // ì£¼ë¬¸ í™•ì¸ ë²„íŠ¼ í´ë¦­ ì‹œ
        confirmOrderButton.addEventListener('click', () => {
        // ì£¼ë¬¸ ë°ì´í„° ìƒì„±
        const orderItems = Object.keys(orderData).map(itemName => {
            const item = orderData[itemName];
            if (item.quantity > 0) {
                return { name: itemName, quantity: item.quantity };
            }
        }).filter(item => item !== undefined);

        console.log('ì „ì†¡í•  ì£¼ë¬¸ ë°ì´í„°:', orderItems);

        // client.pyë¡œ ë°ì´í„° ì „ì†¡
        fetch('http://127.0.0.1:8081/receive_order', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(orderItems),
        })
            .then(response => response.json())
            .then(data => {
                console.log('client.py ì‘ë‹µ:', data);
                alert('ì£¼ë¬¸ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!');
                orderModal.style.display = 'none';

                // í™•ì¸ ë²„íŠ¼ í´ë¦­ í›„ í˜ì´ì§€ ì´ë™
                window.location.href = '/home/capstone/Desktop/index.html';
            })
            .catch(error => {
                console.error('client.py ì „ì†¡ ì˜¤ë¥˜:', error);
                alert('ì£¼ë¬¸ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            });
        });

        // ì·¨ì†Œ ë²„íŠ¼ í´ë¦­ ì‹œ
        cancelOrderButton.addEventListener('click', () => {
            orderModal.style.display = 'none'; // íŒì—… ë‹«ê¸°
        });

        // ìŠ¤í¬ë¡¤ì„ í´ë¦­í•˜ê³  ë°˜ëŒ€ë°©í–¥ìœ¼ë¡œ ë°€ë©´ ìŠ¤í¬ë¡¤ ì´ë™í•˜ê¸°
        let isMouseDown = false;
        let startY;

        itemList.addEventListener('mousedown', (e) => {
            isMouseDown = true;
            startY = e.pageY - itemList.offsetTop;
            itemList.style.cursor = 'grabbing';  // ë§ˆìš°ìŠ¤ í´ë¦­ ì¤‘ì¼ ë•Œ ì»¤ì„œ ë³€ê²½
        });

        itemList.addEventListener('mouseleave', () => {
            isMouseDown = false;
            itemList.style.cursor = 'pointer';
        });

        itemList.addEventListener('mousemove', (e) => {
            if (!isMouseDown) return;

            const offsetY = e.pageY - itemList.offsetTop;
            const scroll = (offsetY - startY) * 1.5; // ìŠ¤í¬ë¡¤ ì†ë„ ì¡°ì ˆ
            itemList.scrollTop -= scroll;  // ìŠ¤í¬ë¡¤ ì´ë™
            startY = offsetY;  // ì‹œì‘ ì§€ì  ì—…ë°ì´íŠ¸
        });

        itemList.addEventListener('mouseup', () => {
            isMouseDown = false;
            itemList.style.cursor = 'pointer';
        });
    </script>
</body>
</html>
